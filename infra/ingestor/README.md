## Bitcoin Ingestor Package

Python agents, environment files, and Terraform scaffolding for the EC2→S3 landing-zone pattern described in the root README.

### Components

- `app/collector.py` – connects to Binance (default) over WebSocket, batches trades, uploads to S3 (`Binance/BTCUSDT/YYYY/MM/DD/HH/mm/`).
- `lambda/news_ingestor` – EventBridge-driven Lambdas for BTC headlines: one RSS collector (`Ext/{news_data_source}/YYYY/MM/DD/`) and one CryptoPanic collector (`Ext/CRYPTOPANIC/...`), both writing batch JSON (separate schedules per source, optional HTML content fetch).
- `lambda/news_content_fetcher` – S3 event–driven Lambda that reads the RSS/CryptoPanic JSON objects, fetches article HTML, extracts text, and writes enriched payloads to `ExtContent/{source}/YYYY/MM/DD/`.
- `codedeploy/` – systemd unit + lifecycle scripts executed by CodeDeploy.
- `.github/workflows/deploy.yml` – GitHub Actions workflow that packages the Lambda, uploads the CodeDeploy bundle, and triggers deployments on `main` pushes.
- `terraform/main.tf` – public VPC, landing + artifact buckets, Lambda, CodeDeploy application/deployment group, and the EC2 Auto Scaling Group.

### Quick Start

1. Copy `.env.example` to `.env` under `app/`, update with real IDs, and push the rendered file into SSM Parameter Store (default key `/mlops/collector/env`).
2. (Optional) Create a Python virtual environment and install requirements:
   ```bash
   cd infra/ingestor/app
   python3 -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   ```
3. Export AWS credentials (ideally via the IAM role attached to the EC2 instance) and run locally if desired:
   ```bash
   python collector.py
   ```
   In production the GitHub Actions → CodeDeploy flow copies `collector.py` onto the EC2 instance and starts `collector.service`.

### Environment Variables (`app/.env.example`)

| Variable | Description |
| --- | --- |
| `AWS_REGION` | AWS region (e.g., `ap-northeast-2`) |
| `S3_BUCKET` | Landing bucket name (defaults to `ybigta-mlops-landing-zone-<acct>`) |
| `DATA_SOURCE` | Logical data source (`Binance`) used for the path prefix |
| `ASSET_SYMBOL` | Trading pair identifier (`BTCUSDT`) |
| `S3_PREFIX` | Optional override for the prefix (default `Binance/BTCUSDT/`) |
| `BATCH_MAX_TRADES` | Flush threshold by record count (default 4,000) |
| `BATCH_MAX_SECONDS` | Flush threshold by time (default 60s) |
| `BATCH_MAX_BYTES` | Flush threshold by approximate payload size (default 2 MB) |
| `EXCHANGE_WS_URL` | WebSocket endpoint for BTC trades |
| `TRADING_PAIR` | Exchange pair identifier (default `btcusdt`) |
| `FILE_FORMAT` | `parquet` or `csv` |

All values can also be provided through real environment variables (preferred in production). `.env` is only for local development convenience.

### Terraform Notes

- Replace the placeholder CIDRs, key pair, bucket prefixes, schedule, etc. in `terraform.tfvars`.
- `news_data_source` controls the RSS Lambda prefix (default `RSS`); `cryptopanic_api_key` is only used by the CryptoPanic Lambda.
- `lambda_schedule_expression` controls RSS cadence (default 5 minutes). `lambda_schedule_expression_cryptopanic` controls CryptoPanic cadence (default 8 hours to stay under ~100 free-tier calls/month).
- `news_fetch_content` toggles fetching article HTML and extracting text into the payload (default `"false"` to minimize latency/calls); `news_content_prefix` is where enriched files are written (`ExtContent` by default). `news_max_article_bytes`/`news_max_article_chars` bound fetch size.
- By default the module creates:
  - Landing S3 bucket `ybigta-mlops-landing-zone-<acct>` (versioning + SSE + lifecycle).
  - Artifact S3 bucket for CodeDeploy bundles generated by GitHub Actions.
  - VPC with one public subnet, IGW, and locked-down security group (SSH ingress + HTTPS/DNS egress).
  - IAM role + instance profile for the EC2 collector.
  - Auto Scaling Group (desired=1) running the collector.
  - EventBridge + Lambda for `Ext/TEST/...` heartbeat payloads.
  - CodeDeploy application + deployment group (GitHub Actions invokes it).
- Copy `terraform.tfvars.example` to `terraform.tfvars`, tweak the values, then run:
  ```bash
  terraform -chdir=infra/ingestor/terraform init
  terraform -chdir=infra/ingestor/terraform apply
  ```

### Automation & Operational Tips

- Configure the following GitHub repository secrets so `.github/workflows/deploy.yml` can assume AWS credentials and trigger deployments:
  - `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_REGION`
  - `CODEDEPLOY_APP_NAME`, `CODEDEPLOY_DEPLOYMENT_GROUP`, `CODEDEPLOY_BUCKET`
  - `NEWS_LAMBDA_NAME` (RSS), `NEWS_LAMBDA_NAME_CRYPTOPANIC` (CryptoPanic), `NEWS_CONTENT_LAMBDA_NAME` (enricher)
- Ensure `/opt/collector/.env` exists on the EC2 instances (Provisioned automatically from the SSM parameter or by manual upload) so `collector.service` can start.
- CodeDeploy executes the scripts under `codedeploy/scripts/`; inspect `/var/log/aws/codedeploy-agent/codedeploy-agent.log` if deployments stall.
- Tune `BATCH_MAX_TRADES`, `BATCH_MAX_SECONDS`, and `BATCH_MAX_BYTES` together to keep objects < 2 MB while meeting latency goals.
- Downstream consumers (Airflow, Glue, Lambda, Batch, another EC2) can read directly from the S3 prefixes whenever you need more processing stages.

### Historical news backfill (CryptoPanic)

Use `infra/ingestor/scripts/backfill_cryptopanic.py` to pull older BTC headlines via CryptoPanic pagination and write them to `Ext/CRYPTOPANIC/YYYY/MM/DD/`:

```bash
python infra/ingestor/scripts/backfill_cryptopanic.py \
  --bucket ybigta-mlops-landing-zone-<account> \
  --api-key <cryptopanic_api_key> \
  --start 2024-01-01 --end 2024-01-31 \
  --max-pages 500
```
